# Сервис, разбирающий инвестиционные идеи

Берет из БД тексты идей в ТГ каналах, отправляет запрос в SpacyNER, разбирает идеи на строки (1 бумага -1 строка), отправляет в новую таблицу в БД.

## Структура проекта 
```
Expander
├── app
│   ├── .env                     # Файл с секретными ключами
│   ├── config.py                # Конфигурационный файл
│   ├── db_connection.py         # Функции загрузки и выгрузки из БД
│   ├── expander.py              # Модуль преобразования таблицы с текстами в таблицу по бумаге
│   ├── fuzzy_sercher.py         # Модуль нечеткого поиска тикеров
│   ├── normalizer.py            # Класс нормализатор сущностей
│   ├── server_app.py            # Серверный файл (FastAPI)
│   ├── spacy_request.py         # Модуль, который обращается к SpacyNER
│   └── ticker_filler.py         # Модуль, добавляющий тикер по названию компании
│
├── sql-base
│   └── base.py                  # Часть SqlAlchemy куда добавлена учетка в БД. Заменяется в основной либе при docker build
│
├── utils
│   └── client.py                # Файл для обращения к сервису запускает распознавание и загрузку в БД
│
├── requirements.txt
└── README.md
```

## Подключение к БД.
В проекте используется PostgreSQL, развернутая на ubuntu-ml  
```
база: tgchannel
таблица: ideas, prices, tickers
```
Для подключения к БД необходимо выполнить следующие шаги:
1. Вписать IP адрес, с которого будет производиться подключение в файл `qhb_hba.config`.
2. Рестартануть БД. Подробная инструкция здесь: https://gitlabsvr.nsd.ru/gitlab/ai/ra/postal/-/issues/6  
3. Вписать connection_string в файл .env
4. В библиотеке sqlalchemy необходимо в файл base.py вписать учетку БД. В проекте есть отредактированный файл, его нужно положить в `site-packages/sqlalchemy/dialects/postgresql`. Это реализовано в докерфайле, поэтому при сборке контейнера выполнится автоматически.

**Важно**  
У контейнеров разные адреса, поэтому сначала необходимо создать контейнер без параметра `--rm` и затем уже его адрес вписать в qhb_hba.config.  


## Запуск в докере
Сборка контейнера:
```
$ docker build -t entities:expander -f Dockerfile .
```
Запуск в демоне:
```
$ docker run -d --name expander -v "$PWD":/usr/src -p 8599:5000 entities:expander 
```
Запуск в интерактивном режиме (не рекомендуется, так как надо добавлять каждый IP):
```
$ docker run --rm -it --name expander -v "$PWD":/usr/src -p 8599:5000 entities:expander bash
```

Запуск в выделенной сети со статичным IP:
```
$ docker run --net telegram --ip 172.24.0.13 -d --name expander -v "$PWD":/usr/src -p 8599:5000 entities:expander
```
Создать сеть, если не создана
```
$ docker network create --subnet=172.24.0.0/16 telegram
```

## Обращение к сервису  
При обращении к сервису необходимо передать 2 параметра (Пока не реализована обработка параметров): 
```
start_date: str         # Дата от в формате "ДД.ММ.ГГГГ"
end_date: bool          # Дата до в формате "ДД.ММ.ГГГГ"
```

В результате запроса обновится БД, в ответе будет текст о том, что она обновлена.  
Пример запроса:
```
import requests

URL = "http://....:8599/expand_ideas"

test = {"start_date": "", "end_date": ""}

resp = requests.post(URL, json=test)
print(resp.text)
```
