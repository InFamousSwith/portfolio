# Парсер картинок и сообщений из телеграмм канала

API-сервис, который парсит телеграмм канал, распознает текст с картинок в сообщениях, объединяет весь текст и направляет БД.  

## Структура проекта 
```
Parser-app
├── app
│   ├── .env                     # Файл с секретными ключами
│   ├── +79685443061.session     # Файл создается во время первого подключения по номеру телефона
│   ├── clean_data.py            # Преобразовывает данные для дальнейшей работы
│   ├── concat_image_text.py     # отправляет запросы на распознавание картинок и добавляет текст из них
│   ├── config.py                # Конфигурационный файл
│   ├── db_uploader.py           # Загружает данный в БД
│   ├── parser_server_app.py     # Основной серверный файл
│   └── parser.py                # Создает сессию в телеграмме и парсит данные (можно самостоятельно запустить)
│
├── data
│   ├── imgs
│   │    └── img_1.jpg           # Все изображения вида img_{message_id}.jpg
│   └── data_for_ls.json         # Файл для разметки в label_studio
│
├── sql-base
│   └── base.py                  # Часть SqlAlchemy куда добавлена учетка в БД. Заменяется в основной либе при docker build
│
├── utils
│   └── client.py                # Файл для обращения к сервису запускает парсинг и загрузку в БД
│
├── .gitignore
├── requirements.txt
└── README.md
```

## Подключение к БД.
В проекте используется PostgreSQL, развернутая на ubuntu-ml  
```
база: tgchannel
таблица: ideas 
```
Для подключения к БД необходимо выполнить следующие шаги:
1. Вписать IP адрес, с которого будет производиться подключение в файл `qhb_hba.config`.
2. Рестартануть БД. Подробная инструкция здесь: https://gitlabsvr.nsd.ru/gitlab/ai/ra/postal/-/issues/6  
3. Вписать connection_string в файл .env
4. В библиотеке sqlalchemy необходимо в файл base.py вписать учетку БД. В проекте есть отредактированный файл, его нужно положить в `site-packages/sqlalchemy/dialects/postgresql`. Это реализовано в докерфайле, поэтому при сборке контейнера выполнится автоматически.

**Важно**  
У контейнеров разные адреса, поэтому сначала необходимо создать контейнер без параметра `--rm` и затем уже его адрес вписать в qhb_hba.config.  

## Подключение к телеграмм сессии
**Получение API ID и Hash.**  
До начала работы с  API Telegram необходимо получить собственный API ID и Hash. Это можно сделать пройдя по ссылке https://my.telegram.org/auth?to=apps, указав номер телефона привязанный к профилю, и заполнив App title и Short name. Platform - можно выбрать “Other (specify in description)”. Остальные параметры можно оставить пустыми.  
После того как все шаги выполнены вы получите собственные API ID и Hash.

После получения токенов, необходимо вписать их в .env как в примере .env_example

## Запуск в докере
Запускать вне докера не рекомендуется, поскольку парсер не работает на рабочих машинах, а распознавание текстов не работает на ubuntu-ml.  
Сборка контейнера:
```
$ docker build -t sql:v2 -f Dockerfile .
```
Запуск в демоне:
```
$ docker run -d --name parser-v1 -v "$PWD":/usr/src -p 9876:5000 sql:v2 
```
Запуск в интерактивном режиме (не рекомендуется, так как надо добавлять каждый IP):
```
$ docker run --rm -it --name parser-v1 -v "$PWD":/usr/src -p 9876:5000 sql:v2 bash
```

Запуск в отдельной сети со статическим IP
```
docker network create --subnet=172.24.0.0/16 telegram
docker run --net telegram --ip 172.24.0.11 -d --name parser-v1 -v "$PWD":/usr/src -p 9876:5000 sql:temp
```

## Обращение к сервису  
При обращении к сервису необходимо передать 3 параметра: 
```
channel_url: str         # Адрес канала
image_job: bool          # Нужно ли распознавание картинок
if_train_dataset: bool   # Нужно ли получить датасет для разметки в label-studio
```

В результате запроса обновится БД, в ответе будет текст о том, что она обновлена.  
Пример запроса:
```
import requests

r = requests.post(
    "http://....:9876/parse_channel",
    json={"channel_url": "https://t.me/bcsinvestidea", "image_job": True, "if_train_dataset": False},
)

print(r.text)
```

## Самостоятельный запуск parser.py 
parser.py может запускаться отдельно.  
Сообщения и картинки имеют одинаковый id - так можно установить соответствие между картинкой и сообщением, датой и другими атрибутами.  
